<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>[MIT6.824 lab2] Raft-Leader election 代码实现 &amp; 踩坑记录 | Zexho&#39; blog</title>
<meta name="description" content="芝兰生于幽谷，不因无人而不芳">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="https://zexho994.github.io/blog.zexho.life/favicon.ico?v=1657628531424">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/papercss@1.6.1/dist/paper.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://zexho994.github.io/blog.zexho.life/styles/main.css">


<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />


  </head>
  <body>
  
    <nav class="navbar border fixed split-nav">
  <div class="nav-brand">
    <h3><a href="https://zexho994.github.io/blog.zexho.life">Zexho&#39; blog</a></h3>
  </div>
  <div class="collapsible">
    <input id="collapsible1" type="checkbox" name="collapsible1">
    <button>
      <label for="collapsible1">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
      </label>
    </button>
    <div class="collapsible-body">
      <ul class="inline">
        
          <li>
            
              <a href="https://zexho994.github.io/blog.zexho.life" class="menu">
                首页
              </a>
            
          </li>
        
          <li>
            
              <a href="https://zexho994.github.io/blog.zexho.life/archives" class="menu">
                时间线
              </a>
            
          </li>
        
          <li>
            
              <a href="https://zexho994.github.io/blog.zexho.life/tags" class="menu">
                标签集
              </a>
            
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div id="top" class="row site">
      <div class="sm-12 md-8 col">
        <div class="paper">
          <article class="article">
            <h1>[MIT6.824 lab2] Raft-Leader election 代码实现 &amp; 踩坑记录</h1>
            <p class="article-meta">
              2022-06-14 07:16:36
              
                <a href="https://zexho994.github.io/blog.zexho.life/tag/fen-bu-shi/" class="badge success">
                  分布式
                </a>
              
                <a href="https://zexho994.github.io/blog.zexho.life/tag/Yh19JUBym/" class="badge success">
                  知识分享
                </a>
              
            </p>
            
            <div class="post-content">
              <blockquote>
<p>本文假设你已经对课程进行了部分了解，所以不对课程的要求进行过多描述，重点在代码的分析和一些踩坑记录和理解。</p>
</blockquote>
<p>课程链接： http://nil.csail.mit.edu/6.824/2020/labs/lab-raft.html</p>
<h2 id="目标">目标</h2>
<p>实现raft算法中的领导人选举部分</p>
<!-- more -->
<h2 id="需要实现的部分">需要实现的部分</h2>
<ol>
<li>Make()</li>
<li>Raft{}</li>
<li>GetState()</li>
<li>RequestVote()</li>
<li>RequestVoteArgs{}</li>
<li>RequestVoteReply{}</li>
<li>AppendEntries()</li>
<li>AppendEntriesArgs {}</li>
<li>AppendEntriesReply {}</li>
</ol>
<h2 id="流程图">流程图</h2>
<p>理解了流程图，要实现代码就比较简单了</p>
<figure data-type="image" tabindex="1"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h37zphn2mhj21gr0k340k.jpg" alt="" loading="lazy"></figure>
<h2 id="code">code</h2>
<p>这里直接展示代码，代码的逻辑配合流程图可以理解清楚。</p>
<h3 id="raft">Raft { }</h3>
<pre><code class="language-go">const Leader int32 = 1
const Follower int32 = 2
const Candidate int32 = 3

type Raft struct {
	mu        sync.Mutex          // Lock to protect shared access to this Peer's state
	peers     []*labrpc.ClientEnd // RPC end points of all peers
	persister *Persister          // Object to hold this Peer's persisted state
	me        int                 // this Peer's index into peers[]
	dead      int32               // set by Kill()

	//任期号
	Term int32
	//获得选票的服务器
	VotedFor int
	//角色类型
	Role int32
	//下一个超时时间
	NextTimeout time.Time
}
</code></pre>
<h3 id="make">Make()</h3>
<p>最先要实现的部分是Make()方法，目的是要创建一个Raft对象、运行后台任务</p>
<pre><code class="language-go">func Make(peers []*labrpc.ClientEnd, me int, persister *Persister, applyCh chan ApplyMsg) *Raft {
	//log.Printf(&quot;== Make() ==&quot;)
	rf := &amp;Raft{}
	rf.peers = peers
	rf.persister = persister
	rf.me = me
	// Your initialization Code here (2A, 2B, 2C).
	rf.Term = 0
	rf.Role = Follower
	rf.VotedFor = -1
	// 设置下次心跳检查时间
	rf.updateHeartbeatTime()
	// 维持状态的协程
	go rf.maintainStateLoop()
	// initialize from state persisted before a crash
	rf.readPersist(persister.ReadRaftState())

	return rf
}
</code></pre>
<p>goroutine 的方法 maintainStateLoop() 负责不停的执行各个角色对应的操作</p>
<pre><code class="language-go">func (rf *Raft) maintainStateLoop() {
	for !rf.killed() {
		rf.mu.Lock()
		if rf.isLeader() {
			rf.maintainsLeader()
		} else if rf.isFollower() {
			rf.maintainsFollower()
		} else if rf.isCandidate() {
			rf.maintainsCandidate()
		} else {
			log.Fatalf(&quot;[raft-%v %v] Role type error : %v \n&quot;, rf.me, rf.getRole(), rf.Role)
		}
	}
}
</code></pre>
<h3 id="follower-的职责">follower 的职责</h3>
<p>判断心跳是否超时，如果超时就变成candidate</p>
<pre><code class="language-go">func (rf *Raft) maintainsFollower() {
	if rf.heartbeatTimeout() {
		rf.changeToCandidate()
		rf.mu.Unlock()
	} else {
		rf.mu.Unlock()
		time.Sleep(10 * time.Millisecond)
	}
}
</code></pre>
<h3 id="candidate-的职责">candidate 的职责</h3>
<p>负责发起竞选的rpc，根据请求的reply进行处理不同的处理</p>
<pre><code class="language-go">func (rf *Raft) maintainsCandidate() {
	// 检查超时
	if !rf.heartbeatTimeout() {
		rf.mu.Unlock()
		time.Sleep(10 * time.Millisecond)
		return
	}

	// 发送投票RPC
	log.Printf(&quot;[raft-%v %v %v] == 发起投票RPC == \n&quot;, rf.me, rf.getRole(), rf.Term)
	rf.VotedFor = rf.me
	rf.Term += 1
	maxTerm, sumVotes := rf.Term, len(rf.peers)
	voteReply := make(chan *RequestVoteReply)
	args := RequestVoteArgs{Peer: rf.me, Term: rf.Term}
	for idx := range rf.peers {
		if rf.me == idx {
			continue
		}
		go func(from int, to int, term int32) {
			reply := RequestVoteReply{Peer: to, Term: term, VoteGranted: false}
			_ = rf.sendRequestVote(to, &amp;args, &amp;reply)
			voteReply &lt;- &amp;reply
		}(rf.me, idx, rf.Term)
	}
	rf.mu.Unlock()

	// 处理投票回复
	validVotes, acceptVotes := 1, 1
	select {
	case reply := &lt;-voteReply:
		validVotes++
		if reply.VoteGranted {
			acceptVotes++
		} else if reply.Term &gt; maxTerm {
			maxTerm = reply.Term
		}
		if validVotes &gt; sumVotes/2 {
			goto VotedDone
		}
	}

	//汇总投票结果
VotedDone:
	rf.mu.Lock()
	defer rf.mu.Unlock()
	if rf.killed() || !rf.isCandidate() {
	} else if maxTerm &gt; rf.Term {
		log.Printf(&quot;[raft-%v-%v-%v] 投票结果: 有更大的Term,放弃竞选: %v.\n&quot;, rf.me, rf.getRole(), rf.Term, maxTerm)
		rf.changeToFollower(maxTerm)
	} else if rf.isQuorum(acceptVotes) {
		log.Printf(&quot;[raft-%v-%v-%v] == 投票通过: 总票数 = %v. 赞同票数 = %v == \n&quot;, rf.me, rf.getRole(), rf.Term, sumVotes, acceptVotes)
		rf.changeToLeader()
	} else {
		log.Printf(&quot;[raft-%v-%v-%v] == 投票未通过: 总票数 = %v. 赞同票数 = %v == \n&quot;, rf.me, rf.getRole(), rf.Term, sumVotes, acceptVotes)
		rf.updateHeartbeatTime()
	}
}

func (rf *Raft) isQuorum(accept int) bool {
	return accept &gt; len(rf.peers)/2
}
</code></pre>
<h3 id="leader-的职责">Leader 的职责</h3>
<p>负责向其他所有节点发送心跳</p>
<pre><code class="language-go">func (rf *Raft) maintainsLeader() {
	//log.Printf(&quot;[raft-%v %v %v] 发送心跳RPC. now = %v&quot;, rf.me, rf.getRole(), rf.Term, time.Now().Local())
	args := AppendEntriesArgs{Peer: rf.me, Term: rf.Term}
	for idx := range rf.peers {
		if idx == rf.me {
			continue
		}
		go func(from int, to int, term int32) {
			reply := AppendEntriesReply{}
			flag := rf.sendAppendEntries(to, &amp;args, &amp;reply)
			rf.mu.Lock()
			defer rf.mu.Unlock()
			if !rf.killed() &amp;&amp; rf.isLeader() &amp;&amp; flag &amp;&amp; reply.Term &gt; rf.Term &amp;&amp; args.Term == rf.Term {
				rf.changeToFollower(reply.Term)
			}
		}(rf.me, idx, rf.Term)
	}
	rf.mu.Unlock()
	time.Sleep(100 * time.Millisecond)
}
</code></pre>
<h3 id="竞选投票相关">竞选投票相关</h3>
<pre><code class="language-go">type RequestVoteArgs struct {
	// 竞选人id
	Peer int
	// 竞选人term
	Term int32
}
</code></pre>
<pre><code class="language-go">type RequestVoteReply struct {
    // 发送回复的节点id
	Peer        int
    // 发送回复的节点term
	Term        int32
    // 如果为true表示赞同
	VoteGranted bool
}
</code></pre>
<pre><code class="language-go">func (rf *Raft) RequestVote(args *RequestVoteArgs, reply *RequestVoteReply) {
	rf.mu.Lock()
	defer rf.mu.Unlock()
	if rf.killed() {
		return
	}

	log.Printf(&quot;[raft-%v %v %v] 处理%v的投票RPC. T = %v \n&quot;, rf.me, rf.getRole(), rf.Term, args.Peer, args.Term)
	reply.Term, reply.VoteGranted = rf.Term, false

	// term太小，不理
	if args.Term &lt; rf.Term {
		return
	}

	// 更大的term
	if args.Term &gt; rf.Term {
		rf.changeToFollower(args.Term)
	}

	// 每个任期，只能投票一次
	if rf.VotedFor == -1 || rf.VotedFor == args.Peer {
		reply.VoteGranted = true
		rf.VotedFor = args.Peer
		rf.updateHeartbeatTime()
	}
}
</code></pre>
<h3 id="心跳相关">心跳相关</h3>
<pre><code class="language-go">type AppendEntriesArgs struct {
	Peer int
	Term int32
}
</code></pre>
<pre><code class="language-go">type AppendEntriesReply struct {
	Term   int32
	Result bool
}

</code></pre>
<pre><code class="language-go">func (rf *Raft) AppendEntries(args *AppendEntriesArgs, reply *AppendEntriesReply) {
	rf.mu.Lock()
	defer rf.mu.Unlock()
	if rf.killed() {
		return
	}
	//log.Printf(&quot;[raft-%v %v %v] 接收来自%v的心跳请求. T = %v.\n&quot;, rf.me, rf.getRole(), rf.Term, args.Peer, args.Term)
	reply.Term, reply.Result = rf.Term, args.Term &gt;= rf.Term

	if args.Term &lt; rf.Term {
		return
	} else if rf.isCandidate() {
		rf.changeToFollower(args.Term)
	} else {
		rf.updateHeartbeatTime()
	}

	// 日志操作lab-2A不实现
	rf.persist()
}
</code></pre>
<h2 id="注意事项">注意事项</h2>
<pre><code class="language-text">--- FAIL: TestReElection2A (8.51s)
    config.go:330: expected one leader, got none
</code></pre>
<p>在这个test case中，先disconnect已经选出来的leader，然后给2s的时间选举出新的leader，这里的错误原因就是2s时间没有选举出新的leader。<br>
要点在于如何提高选举的效率，保证更快的时间内（2s内）选举出leader，<br>
出现这个情况的原因大概率和活锁有关，两个或多个candidate争夺竞选，这里注意一些要点：</p>
<ol>
<li>关于选举间隔时间：建议 150 ~ 300 之间
<ul>
<li>设置太高会浪费空闲时间</li>
<li>设置太低又容易发生活锁，也存在一种情况就是leader选举出来了，但是又收到term更高的vote rp请求。</li>
</ul>
</li>
<li>当选leader，应该尽快发送心跳rpc，防止follow过期</li>
<li>leader 发送心跳的频率 ， 建议在100ms一次，官方也是建议1s不超过10次</li>
</ol>
<p>关于更新心跳时间的条件，首先本质上就是在收到有效的rpc请求时（知道有别人存活）或者自己发起选举时（知道自己存活），就要更新心跳时间，如下三个点：</p>
<ul>
<li>收到leader的心跳rpc时（leader.term &gt;= self.term 即算有效）</li>
<li>收到candidate的投票请求，并投了赞同票时</li>
<li>在进行新一轮的选举时</li>
</ul>
<h2 id="脚本测试">脚本测试</h2>
<blockquote>
<p>测试脚本: https://gist.github.com/jonhoo/</p>
</blockquote>
<p>250 次测试结果通过<br>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h386800abjj20hi064q3q.jpg" alt="" loading="lazy"></p>
<h2 id="reference">Reference</h2>
<ul>
<li>
<p>参考使用chan + select 的模式： https://yuerblog.cc/2020/08/13/mit-6-824-distributed-systems-%E5%AE%9E%E7%8E%B0raft-lab2a/</p>
</li>
<li>
<p>raft论文(中文) :  https://yuerblog.cc/wp-content/uploads/raft-zh_cn.pdf  [ 主要看5.2 leader 选举部分 ]</p>
</li>
<li>
<p>https://mit-public-courses-cn-translatio.gitbook.io/mit6-824/lecture-06-raft1/6.8-xuan-ju-ding-shi-qi-election-timer</p>
</li>
<li>
<p>一些注意事项 : https://zhuanlan.zhihu.com/p/368433074</p>
</li>
</ul>

            </div>
          </article>
        </div>
        <div class="paper" data-aos="fade-in">
          
            <div class="next-post">
              <div class="next">
                下一篇
              </div>
              <a href="https://zexho994.github.io/blog.zexho.life/post/mit-6824-lab1-mapreduce-she-ji/">
                <h3 class="post-title">
                  Mit 6.824 lab1 MapReduce 设计
                </h3>
              </a>
            </div>
          
        </div>
        
      </div>

      <div class="sm-12 md-4 col sidebar">
  <div class="paper info-container">
    <img src="https://zexho994.github.io/blog.zexho.life/images/avatar.png?v=1657628531424" class="no-responsive avatar">
    <div class="text-muted">芝兰生于幽谷，不因无人而不芳</div>
    <div class="social-container">
      
        
          <a href="https://github.com/zexho994" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
      
        
      
        
      
        
      
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      最新文章
    </div>
    <div class="row">
      <ul>
        
          
            <li>
              <a href="https://zexho994.github.io/blog.zexho.life/post/mit6830-shu-ju-ku-shi-xian-lab1-ji-lu/">MIT6.830 数据库实现：lab1 记录</a>
            </li>
          
        
          
            <li>
              <a href="https://zexho994.github.io/blog.zexho.life/post/shen-ru-qian-chu-raft-xie-yi/">深入浅出 Raft 协议</a>
            </li>
          
        
          
            <li>
              <a href="https://zexho994.github.io/blog.zexho.life/post/mit6824-lab2-raft2c-chi-jiu-hua-shi-xian-yao-dian-and-cai-keng-ji-lu/">[MIT6.824 lab2] Raft2C-持久化 实现要点 &amp; 踩坑记录</a>
            </li>
          
        
          
            <li>
              <a href="https://zexho994.github.io/blog.zexho.life/post/mit6824-lab2-raft2b-ri-zhi-tong-bu-shi-xian-yao-dian-and-cai-keng-ji-lu/">[MIT6.824 lab2] Raft2B-日志同步 实现要点 &amp; 踩坑记录</a>
            </li>
          
        
          
            <li>
              <a href="https://zexho994.github.io/blog.zexho.life/post/mit6824-lab2-raft-leader-election-dai-ma-shi-xian-and-cai-keng-ji-lu/">[MIT6.824 lab2] Raft-Leader election 代码实现 &amp; 踩坑记录</a>
            </li>
          
        
          
            <li>
              <a href="https://zexho994.github.io/blog.zexho.life/post/mit-6824-lab1-mapreduce-she-ji/">Mit 6.824 lab1 MapReduce 设计</a>
            </li>
          
        
          
            <li>
              <a href="https://zexho994.github.io/blog.zexho.life/post/ji-ge-you-qu-de-gai-lu-wen-ti/">几个有趣的概率问题</a>
            </li>
          
        
          
            <li>
              <a href="https://zexho994.github.io/blog.zexho.life/post/tong-su-li-jie-basic-pasox/">通俗理解 Basic Paxos</a>
            </li>
          
        
          
            <li>
              <a href="https://zexho994.github.io/blog.zexho.life/post/wo-li-jie-de-cap/">我理解的CAP</a>
            </li>
          
        
          
            <li>
              <a href="https://zexho994.github.io/blog.zexho.life/post/kuai-su-kan-qing-lambda-de-ben-zhi/">快速看清lambda的本质</a>
            </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      标签列表
    </div>
    <div class="row">
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/fen-bu-shi/" class="badge warning">
          分布式
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/Yh19JUBym/" class="badge secondary">
          知识分享
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/KrLfgh9WlS/" class="badge secondary">
          造轮子
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/xue-xi-gui-na/" class="badge secondary">
          学习归纳
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/6j9B3b2nb/" class="badge warning">
          Java
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/_Ywd8fi71/" class="badge secondary">
          RocketMQ
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/yuan-ma/" class="badge ">
          源码
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/jjLsZt3QW/" class="badge secondary">
          JVM
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/P-ZT7Pj1-8/" class="badge secondary">
          Spring
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/docker/" class="badge success">
          docker
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/tu-shu-ju-ku/" class="badge secondary">
          图数据库
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/THZXOECNJ/" class="badge ">
          Git
        </a>
      
        <a href="https://zexho994.github.io/blog.zexho.life/tag/59D97ArOs/" class="badge ">
          微信小程序
        </a>
      
    </div>
  </div>
  <div class="paper">
    Life & Coding | <a class="rss" href="https://zexho994.github.io/blog.zexho.life/atom.xml" target="_blank">RSS</a>
  </div>
</div>


    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

</script>




  </body>
</html>
